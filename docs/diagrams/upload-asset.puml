@startuml

skinparam dpi 300
title The sequence of creating a file attachment in Whitehall

box "Whitehall" #f2fef8
actor editor
participant AttachmentController
participant Attachment
database mysql
participant AssetManagerStorage
database filesystem
participant CreateWhitehallAssetWorker
participant AttachmentSetUploadedToWorker
participant AttachmentUpdater
end box

box "Asset Manager" #f2f8fe
participant asset_manager
participant Asset
database am_filesystem
participant VirusScanner
participant SaveToCloudStorageWorker
database S3
end box


editor -> AttachmentController : upload an asset
AttachmentController -> Attachment : save
Attachment -> mysql : Store Asset meta information

group carrierwave
    Attachment -> AssetManagerStorage : Trigger carrierwave magic
    AssetManagerStorage -> filesystem : Store temporary file
    AssetManagerStorage -> CreateWhitehallAssetWorker : Enqueue a background job
end group

group sidekiq
    CreateWhitehallAssetWorker -> asset_manager : Upload the file to Asset Manager
    CreateWhitehallAssetWorker -> AttachmentSetUploadedToWorker : Enqueue a background job
    CreateWhitehallAssetWorker -> filesystem : Remove file
end group

group sidekiq
    AttachmentSetUploadedToWorker -> mysql : Update the timestamp of when the file was uploaded
    Attachment -> AttachmentUpdater : Enqueue background job
end group

group sidekiq
    AttachmentUpdater -> asset_manager : AccessLimitedUpdates
    AttachmentUpdater -> asset_manager : DraftStatusUpdates
    AttachmentUpdater -> asset_manager : LinkHeaderUpdates
    AttachmentUpdater -> asset_manager : RedirectUrlUpdates
    AttachmentUpdater -> asset_manager : ReplacementIdUpdates
end group

group carrierwave
    asset_manager -> Asset : Save
    Asset -> am_filesystem : Store temporary file
    Asset -> VirusScanner : Enqueue virus scanner
end group

group sidekiq
    VirusScanner -> Asset : Update state to be "clean"
    Asset -> SaveToCloudStorageWorker : Enqueue SaveToCloudStorageWorker
end group

group sidekiq
    SaveToCloudStorageWorker -> S3 : Upload to S3
    SaveToCloudStorageWorker -> Asset : Update state to be "uploaded"
    Asset -> am_filesystem : Remove temp file
end group


@enduml
